name: Photopixels BE nightly API tests
run-name: "Nightly BE API — ${{ github.ref_name }} #${{ github.run_number }}"

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 4 * * *'

env:
  AUTOMATION_REPO_PATH: automation
  BACKEND_REPO_PATH: backend
  COMPOSE_FILE: ${{ github.workspace }}/automation/utils/docker-compose.yml
  BACKEND_TAG: scalefocusad/photopixels-backend-net:automation
  AUTOMATION_TAG: scalefocusad/photopixels-automated-tests:automation

jobs:
  build-be:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
        with:
          repository: scalefocus/photopixels-backend-net
          submodules: recursive
          fetch-depth: 0
          path: ${{ env.BACKEND_REPO_PATH }}
      - name: Build docker image (BE)
        working-directory: ${{ env.BACKEND_REPO_PATH }}
        run: |
          docker build \
            --no-cache \
            --build-arg VERSION="1.0.0" \
            --build-arg VERSION_SUFFIX="" \
            -t "$BACKEND_TAG" \
            -f ./src/SF.PhotoPixels.API/Dockerfile .

  build-automation:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: ${{ env.AUTOMATION_REPO_PATH }}
      - name: Build docker image (automation tests)
        working-directory: ${{ env.AUTOMATION_REPO_PATH }}
        run: |
          docker build --no-cache -f ./Dockerfile -t "$AUTOMATION_TAG" .

  automation:
    runs-on: self-hosted
    needs: [build-be, build-automation]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: ${{ env.AUTOMATION_REPO_PATH }}
      - name: Start environment (backend + db only)
        run: |
          docker compose -f "${COMPOSE_FILE}" pull backend db || true
          docker compose -f "${COMPOSE_FILE}" up -d backend db
      - name: Run API tests
        id: run-tests
        continue-on-error: true
        run: |
          docker run -i --name api-tests \
            -e BASE_URI="http://backend:8080/" \
            -e SUITE_NAME="api" \
            --network utils_sf-photos-net \
            "$AUTOMATION_TAG"
      - name: Collect test artifacts
        if: always()
        run: |
          set -e
          mkdir -p "${GITHUB_WORKSPACE}/test-artifacts"
          docker cp api-tests:/app/target/surefire-reports "${GITHUB_WORKSPACE}/test-artifacts/surefire-reports" || true
          docker cp api-tests:/app/target/allure-results   "${GITHUB_WORKSPACE}/test-artifacts/allure-results"   || true
      - name: Upload raw artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: be-api-test-artifacts
          path: test-artifacts/**
          if-no-files-found: warn
          retention-days: 14
      - name: Cleanup
        if: always()
        run: |
          docker rm -f api-tests || true
          docker compose -f "$COMPOSE_FILE" down -v || true

  allure-report-email:
    runs-on: self-hosted
    needs: [automation]
    if: always()
    steps:
      - name: Set workspace-scoped paths (visible in action container)
        shell: bash
        run: |
          echo "ART_DIR=${GITHUB_WORKSPACE}/ci-artifacts" >> "$GITHUB_ENV"
          echo "REPORT_DIR=${GITHUB_WORKSPACE}/ci-allure-report" >> "$GITHUB_ENV"
          mkdir -p "${GITHUB_WORKSPACE}/ci-artifacts" "${GITHUB_WORKSPACE}/ci-allure-report"

      - name: Download test artifacts (into workspace)
        uses: actions/download-artifact@v4
        with:
          name: be-api-test-artifacts
          path: ${{ env.ART_DIR }}

      - name: Generate Allure report (paths under $GITHUB_WORKSPACE)
        id: gen
        continue-on-error: true
        uses: simple-elf/allure-report-action@v1.8
        with:
          allure_results: ${{ env.ART_DIR }}/allure-results
          allure_report: ${{ env.REPORT_DIR }}

      - name: Verify Allure output
        shell: bash
        run: |
          echo "=== REPORT_DIR tree ==="; ls -la "$REPORT_DIR" || true
          [ -f "$REPORT_DIR/index.html" ] && echo "index.html: OK" || echo "index.html: MISSING"
          [ -f "$REPORT_DIR/widgets/summary.json" ] && echo "summary.json: OK" || echo "summary.json: MISSING"

      - name: Extract summary (prefer Allure, fallback to Surefire)
        id: summary
        shell: bash
        run: |
          set -e
          TOTAL=0; FAILED=0; BROKEN=0; SKIPPED=0; PASSED=0
          if [ -f "$REPORT_DIR/widgets/summary.json" ]; then
            PASSED=$(grep -o '"passed":[0-9]\+'  "$REPORT_DIR/widgets/summary.json" | head -1 | cut -d: -f2 || echo 0)
            FAILED=$(grep -o '"failed":[0-9]\+'  "$REPORT_DIR/widgets/summary.json" | head -1 | cut -d: -f2 || echo 0)
            BROKEN=$(grep -o '"broken":[0-9]\+'  "$REPORT_DIR/widgets/summary.json" | head -1 | cut -d: -f2 || echo 0)
            SKIPPED=$(grep -o '"skipped":[0-9]\+' "$REPORT_DIR/widgets/summary.json" | head -1 | cut -d: -f2 || echo 0)
            TOTAL=$(grep -o '"total":[0-9]\+'    "$REPORT_DIR/widgets/summary.json" | head -1 | cut -d: -f2 || echo 0)
          else
            for f in "$ART_DIR"/surefire-reports/TEST-*.xml; do
              [ -f "$f" ] || continue
              line=$(head -1 "$f")
              t=$(echo "$line"  | sed -n 's/.*tests="\([0-9]\+\)".*/\1/p')
              fa=$(echo "$line" | sed -n 's/.*failures="\([0-9]\+\)".*/\1/p')
              er=$(echo "$line" | sed -n 's/.*errors="\([0-9]\+\)".*/\1/p')
              sk=$(echo "$line" | sed -n 's/.*skipped="\([0-9]\+\)".*/\1/p')
              TOTAL=$((TOTAL + ${t:-0}))
              FAILED=$((FAILED + ${fa:-0}))
              BROKEN=$((BROKEN + ${er:-0}))
              SKIPPED=$((SKIPPED + ${sk:-0}))
            done
            PASSED=$((TOTAL - FAILED - BROKEN - SKIPPED))
            [ $PASSED -lt 0 ] && PASSED=0 || true
          fi
          VERDICT="PASSED"; [ $((FAILED + BROKEN)) -gt 0 ] && VERDICT="FAILED"
          {
            echo "passed=$PASSED"
            echo "failed=$FAILED"
            echo "broken=$BROKEN"
            echo "skipped=$SKIPPED"
            echo "total=$TOTAL"
            echo "verdict=$VERDICT"
          } >> "$GITHUB_OUTPUT"

      - name: Build failed-tests table HTML from Surefire XML
        id: failedtbl
        shell: bash
        run: |
          set -e
          rows=""
          shopt -s nullglob
          for f in "$ART_DIR"/surefire-reports/TEST-*.xml; do
            cls=""
            name=""
            msg=""
            while IFS= read -r line; do
              case "$line" in
                *"<testcase "*)
                  cls=$(printf '%s\n' "$line" | sed -n 's/.*classname="\([^"]*\)".*/\1/p')
                  name=$(printf '%s\n' "$line" | sed -n 's/.*name="\([^"]*\)".*/\1/p')
                  msg=""
                  ;;
                *"<failure "*|*"<error "*)
                  msg=$(printf '%s\n' "$line" | sed -n 's/.*message="\([^"]*\)".*/\1/p')
                  if [ -n "$msg" ]; then
                    esc_full=$(printf '%s.%s' "$cls" "$name" | sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g')
                    tmp_msg=$(printf '%s' "$msg" | sed -e 's/&#10;/___BR___/g' -e 's/\\n/___BR___/g' -e 's/\r\n/___BR___/g')
                    esc_msg=$(printf '%s' "$tmp_msg" | sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g')
                    esc_msg=$(printf '%s' "$esc_msg" | sed -e 's/\&amp;lt;/\&lt;/g' -e 's/\&amp;gt;/\&gt;/g' -e 's/\&amp;quot;/\&quot;/g' -e 's/\&amp;\#10;/___BR___/g')
                    esc_msg=$(printf '%s' "$esc_msg" | sed -e 's/___BR___/<br\/>/g')
                    rows="${rows}<tr><td><b>${esc_full}</b><br/><div style=\"white-space:pre-wrap;margin:4px 0;\">${esc_msg}</div></td></tr>"$'\n'
                  fi
                  ;;
              esac
            done < "$f"
          done

          if [ -n "$rows" ]; then
            {
              echo '<h3>Failed tests:</h3><table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; width:100%;">'
              echo '<thead><tr style="background:#f5f5f5;"><th style="text-align:left;">Test &amp; reason</th></tr></thead><tbody>'
              printf "%s\n" "$rows"
              echo '</tbody></table>'
            } > /tmp/failed_table.html
          else
            echo '<h3>Failed tests:</h3><p><i>No failed/broken tests.</i></p>' > /tmp/failed_table.html
          fi

          oneline=$(tr '\n' ' ' < /tmp/failed_table.html | sed 's/  \+/ /g')
          echo "table=$oneline" >> "$GITHUB_OUTPUT"

      - name: Conditionally upload Allure HTML (skip if missing)
        shell: bash
        run: |
          if [ -f "$REPORT_DIR/index.html" ]; then
            echo "UPLOAD_HTML=true" >> "$GITHUB_ENV"
          else
            echo "UPLOAD_HTML=false" >> "$GITHUB_ENV"
          fi

      - uses: actions/upload-artifact@v4
        if: env.UPLOAD_HTML == 'true'
        with:
          name: allure-html-report
          path: ${{ env.REPORT_DIR }}/**
          retention-days: 14

      - name: Send email with Allure report (link only, no attachment)
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          secure: ${{ secrets.SMTP_SECURE }}
          from: ${{ secrets.SMTP_FROM != '' && secrets.SMTP_FROM || secrets.SMTP_USERNAME }}
          to: ${{ secrets.SMTP_TO }}
          subject: "Photopixels BE nightly API tests — ${{ steps.summary.outputs.verdict || 'PASSED' }}"
          html_body: |
            <p>Hello team,</p>
            <p>The nightly BE run of the automation tests finished with status: <b>${{ steps.summary.outputs.verdict || 'PASSED' }}</b>.</p>

            <h3>Summary:</h3>
            <table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse;">
              <tr>
                <th>Total</th>
                <th>Passed</th>
                <th>Failed</th>
                <th>Broken</th>
                <th>Skipped</th>
              </tr>
              <tr>
                <td align="center">${{ steps.summary.outputs.total || '0' }}</td>
                <td align="center" style="color:green;"><b>${{ steps.summary.outputs.passed || '0' }}</b></td>
                <td align="center" style="color:red;"><b>${{ steps.summary.outputs.failed || '0' }}</b></td>
                <td align="center" style="color:#b10;"><b>${{ steps.summary.outputs.broken || '0' }}</b></td>
                <td align="center" style="color:gray;"><b>${{ steps.summary.outputs.skipped || '0' }}</b></td>
              </tr>
            </table>

            <div style="margin-top:12px;">
              ${{ steps.failedtbl.outputs.table }}
            </div>

            <p>
              <ul>
                <li>Workflow summary &amp; Allure report: <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">open</a></li>
              </ul>
            </p>

            <p>Best regards,<br/>GitHub Actions</p>
